FROM python:3.11-slim

WORKDIR /app

# Install system dependencies
RUN apt-get update && apt-get install -y \
    gcc \
    && rm -rf /var/lib/apt/lists/*

# Copy requirements first to leverage Docker cache
COPY requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt

# Copy all project files
COPY . .

# Create a non-root user
RUN useradd -m appuser
RUN chown -R appuser:appuser /app
USER appuser

# Create a startup script
RUN echo '#!/bin/bash\n\
# Check if we need to create identity\n\
if [ ! -f "privkey.pem" ] || ! grep -q "DID_PLC" config.py; then\n\
    echo "Creating new identity..."\n\
    # Run create_identity.py and capture the DID\n\
    DID=$(python create_identity.py | grep "Created DID:" | cut -d" " -f3)\n\
    if [ -n "$DID" ]; then\n\
        echo "Updating config.py with DID: $DID"\n\
        # Update config.py with the new DID\n\
        sed -i "s/DID_PLC = .*/DID_PLC = \"$DID\"/" config.py\n\
        # Run request_crawl.py after successful identity creation\n\
        python request_crawl.py\n\
    else\n\
        echo "Failed to create identity"\n\
        exit 1\n\
    fi\n\
else\n\
    echo "Using existing identity..."\n\
fi\n\
\n\
# Start the PDS\n\
exec python pds.py' > /app/start.sh && \
chmod +x /app/start.sh

# Expose the port the app runs on
EXPOSE 31337

# Command to run the application
CMD ["/app/start.sh"] 